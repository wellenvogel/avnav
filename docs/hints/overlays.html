<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Overlays</title>
    <link href="../styles.css" rel="stylesheet" type="text/css">
  </head>
  <body data-order="800">
    <h1>Avnav Overlays</h1>
    <div class="toc"> </div>
    <p>Ab der Version 20201219 ist AvNav in der Lage, neben der eigentlichen
      Karte noch Zusatzinformationen anzuzeigen. Das können z.B. Wegpunkte aus
      einer GPX Datei aber auch vorhandene Tracks oder andere Daten (wie z.B.
      aktuelle Tonnen von <a href="https://www.nautin.nl/wb/pages/navigatie/actuele-boeienposities.php">nautin.nl</a>)
      sein.</p>
    <p>Daneben können mit dieser neuen Funktionalität auch mehrere Karten
      übereinander gelegt werden (z.B. eine OpenSeamap Karte, die einen weiteren
      Bereich abdeckt, unter eine o-charts Karte - oder auch o-charts Karten für
      verschiedene Regionen).</p>
    <p>Innerhalb von AvNav wird diese Funktion als Overlays bezeichnet.</p>
    <p>Im Einzelnen können die folgenden Daten als Overlays genutzt werden:</p>
    <ul>
      <li>GPX Dateien (Wegpunkte,Tracks,Routen)</li>
      <li><a href="https://developers.google.com/kml/documentation/kmzarchives">KML
          und KMZ</a> Dateien (google) - ind der KMZ Datei wird eine doc.kml
        erwartet.</li>
      <li><a href="https://de.wikipedia.org/wiki/GeoJSON">geojson</a> Dateien</li>
      <li>andere in AvNav vorhandene Karten</li>
      <li>AvNav Routen</li>
      <li>AvNav Tracks</li>
    </ul>
    <p>Zu den GPX und KML Dateien können nutzerdefinierte Icons oder auch Daten,
      die über "link" Tags erreichbar sind, als zip Dateien gespeichert werden.
      KMZ Dateien enthalten diese Icons im Normalfall schon.</p>
    <p>Wenn solche Overlays auf einer Karte vorhanden sind, können durch Klick
      auf entsprechende Punkte dazu Zusatzinformationen abgerufen werden.</p>
    <h2><a name="configuration"></a>Konfiguration</h2>
    <p>Bevor externe Overlays genutzt werden können, müssen die Dateien in AvNav
      hochgeladen werden.</p>
    <p><img src="DownloadPage-Overlays.png" alt="" class="fimage"></p>
    <p>Innerhalb von AvNav wird das Symbol <img src="../viewerimages/icons-new/layers-black.svg"
        alt="" class="inlineimage">für Overlays benutzt.</p>
    <p>Nachdem die entsprechenden Dateien hochgeladen wurden, können diese
      Overlays den Karten zugeordnet werden. Man kann einen Satz von Overlays
      definieren, der für alle Karten genutzt werden soll (default overlays).
      Ausserdem kann man für jede einzelne Karte noch definieren, welche
      Overlays auf dieser angezeigt werden sollen.</p>
    <p>Die Konfiguration der Overlays kann entweder auf der <a href="../userdoc/downloadpage.html">Files/Download-Seite</a>
      im Reiter Karten erfolgen - oder auf der <a href="../userdoc/mainpage.html">Hauptseite</a>.</p>
    <p><img src="Overlay-Config-Default-DownloadPage.png" alt="" class="fimage"></p>
    <p>Im Bild ist der Dialog sichtbar, der nach Klick auf "DefaultOverlays" auf
      der Files/Download Seite erreichbar ist.</p>
    <p>Hier können jetzt Overlays hinzugefügt, verändert oder gelöscht werden.</p>
    <p><img src="Overlay-Config-Default-Select1.png" alt="" class="fimage"></p>
    <p>Im Bild wurde hier mit "InsertAfter" die Auswahl der vorhandenen Overlays
      aufgerufen.<br>
      Im Beispiel wurde die im overlays Verzeichnis vorhandene Datei
      Wegepunkte2024.gpx (<a href="https://nvcharts.com/downloads/wegepunkte/2024/Wegepunkte2024_gpx.zip">NV
        Verlag</a>)&nbsp; gewählt.<br>
      Es können jetzt noch Parameter für die Anzeige eingestellt werden.</p>
    <table width="100%" border="1">
      <tbody>
        <tr>
          <td>Name</td>
          <td>default</td>
          <td>Beschreibung</td>
        </tr>
        <tr>
          <td>enable</td>
          <td>ja</td>
          <td>Wenn das deaktiviert wird, ist das Overlay zwar konfiguriert
            - wird aber aktuell nicht angezeigt. Man hat aber später die
            Möglichkeit, das mit einem Klick anzuzeigen.</td>
        </tr>
        <tr>
          <td>type</td>
          <td>overlay</td>
          <td>Art des Overlays.<br>
            overlay: eine Datei, die unter overlays hochgeladen wurde<br>
            chart: eine in AvNav vorhandene Karte<br>
            route: eine in AvNav vorhandene Route<br>
            track: ein in AvNav vorhander Track</td>
        </tr>
        <tr>
          <td>overlay name</td>
          <td>---</td>
          <td>hier wird je nach type die Liste der vorhandenen Elemente zur
            Auswahl angeboten</td>
        </tr>
        <tr>
          <td>featureFormatter</td>
          <td>---</td>
          <td>Auswahl einer Java Script Funktion zum Aufbereiten von
            zusätzlichen Informationen bei Klick auf das Element</td>
        </tr>
        <tr>
          <td>opacity</td>
          <td>1</td>
          <td>Ein Wert zwischen 0...1, der die Farbdeckung angibt (0:
            unsichtbar)</td>
        </tr>
        <tr>
          <td>icon file</td>
          <td>---</td>
          <td>Hier kann eine zip-Datei angegeben werden, die die Bilder (oder
            sonstigen Inhalte) entält.<br>
            Wenn in einer gpx-Datei eine "sym" Eigenschaft vorhanden ist (z.B.
            sym="b1"), wird in der Zip Datei zur Darstellung eine Datei b1.png
            gesucht.<br>
            Wenn eine link Eigenschaft vorhanden ist (z.B. link="data/1.html")
            dann wird in der Zip Datei nach einem Eintrag data/1.html gesucht.<br>
            Für KML Dateien gilt das sinngemäss. Allerdings empfiehlt sich
            hierbei eher die Nutzung des KMZ Formates.</td>
        </tr>
        <tr>
          <td>min zoom</td>
          <td>0</td>
          <td>der minimale Karten-Zoom bei dem das Overlay noch angezeigt wird
            (0: immer)</td>
        </tr>
        <tr>
          <td>max zoom</td>
          <td>0</td>
          <td>der maximale Karten-Zoom bei dem das Overlay noch angezeigt wird
            (0: immer)</td>
        </tr>
        <tr>
          <td>min scale</td>
          <td>0</td>
          <td>wenn der Kartenzoom kleiner als min scale ist, werden die Icons
            verkleinert (0: Funktion deaktiviert)</td>
        </tr>
        <tr>
          <td>max scale</td>
          <td>0</td>
          <td>wenn der Kartenzoom grösser als max scale ist, werden die Icons
            vergrößert (0: Funktion deaktiviert)</td>
        </tr>
        <tr>
          <td>default icon</td>
          <td>--none--</td>
          <td>Hier kann eine Bild-Datein (png, svg) ausgewählt werden, die als
            Icon genutzt werden soll, wenn kein anderes Icon gefunden wurde. Die
            Bild-Datei muss vorher bei layouts (oder user Dateien oder Images)
            hochgeladen worden sein.<br>
            Mit --DefaultGpxIcon-- kann ein Icon gewählt werden, das AvNav
            bereits mitbringt. <img src="../viewerimages/icons-new/DefaultGpxPoint.png"
              alt="" class="inlineimage"></td>
        </tr>
        <tr>
          <td>show text</td>
          <td>nein</td>
          <td>Zeige Text (z.B. Punkt-Namen)</td>
        </tr>
        <tr>
          <td>feature Formatter</td>
          <td>---</td>
          <td>wähle einen <a href="userjs.html#featureFormatter">Feature
              Formatierer</a> der benutzt wird, um die Informationen für die
            Anzeige aufzubereiten, wenn auf der Karte auf das Overlay geklickt
            wird.</td>
        </tr>
      </tbody>
    </table>
    <p>Falls die Datei andere Inhalte hat als Wegpunkte, werden ggf. noch
      weitere Auswahlmöglichkeiten angeboten.</p>
    <p><img src="Overlay-Config-Default-Select2.png" alt="" class="fimage"></p>
    <table width="100%" border="1">
      <tbody>
        <tr>
          <td>Name</td>
          <td>default</td>
          <td>Beschreibung</td>
        </tr>
        <tr>
          <td>line width</td>
          <td>track/route line width</td>
          <td>Die Linienstärke für die Darstellung</td>
        </tr>
        <tr>
          <td>line color</td>
          <td>track/route color</td>
          <td>Die Farbe für die Darstellung</td>
        </tr>
      </tbody>
    </table>
    <p>Nach Bestätigung mit Ok ist das Overlay jetzt hinzugefügt.</p>
    <img src="Overlay-Config-Default-SelectList.png" alt="" class="fimage"><br>
    <p>Die Reihenfolge der Overlays kann in der Liste per drag&amp;drop geändert
      werden - sie können auch "unterhalb" der Karten angezeigt werden - dann
      vor die ---chart--- Reihe verschieben.</p>
    <p>Für die default overlays macht es u.U. Sinn, diese zunächst disabled zu
      haben - und dann erst bei den einzelnen Karten (oder wenn sie benötigt
      werden) anzuschalten.</p>
    <p>Für Karten sieht die Overlay Konfiguration dann so aus:</p>
    <img src="Overlay-Config-Default-SelectListNormal.png" alt="" class="fimage">
    <p>Hier können die unter default konfigurierten Overlays nur verschoben und
      an- bzw. abgeschaltet werden, die Overlays nur für diese Karte können
      bearbeitet werden.</p>
    <p>Die Overlay-Konfiguration kann auch auf der Hauptseite durch Klick auf
      den <img src="../viewerimages/icons-new/layers-black.svg" alt="" class="inlineimage">Button
      neben der jeweiligen Karte erreicht werden.</p>
    <p><img src="Overlay-Config-Mainpage.png" alt="" class="fimage"></p>
    <p>Der Button auf der rechten Seite führt zur Konfiguration der default
      overlays.</p>
    <p>Für Tracks und Routen kann man die Overlay Konfiguration auch von der
      Files/Download Seite starten, indem man eine Route oder einen gpx Track
      auswählt.</p>
    <p><img src="Overlay-Config-Track1.png" alt="" class="fimage"> </p>
    <p>Im Bild wurde auf einen gpx Track geklickt. Durch Auswahl von "Overlays"
      kann man diesen Track jetzt overlays zuordnen (oder ihn entfernen).</p>
    <p><img src="Overlay-Config-Track2.png" alt="" class="fimage"></p>
    <p>Nachdem man sich entschieden hat, ob man den Track den default overlays
      oder einer spezifischen Karte zuordnen möchte, kommt man zur normalen
      Overlay Konfiguration.</p>
    <p>Wenn man "Remove from Charts" auswählt, wird der Track von allen overlays
      entfernt.</p>
    <h2><a name="usage"></a>Nutzung</h2>
    <p>Wenn eine Karte ausgewählt wird, wird sie zusammen mit ihren Overlays
      dargestellt.</p>
    <img src="Overlay-Example-Maps-Waypoints.png" alt="" class="fimage">
    <p>Im Beispiel eine o-charts Karte mit einer OpenStreetMap Karte darunter
      und einer Wegpunkt-Datei darüber.<br>
      Als Icon wurde das DefaultGpxIcon gewählt.<br>
      Wenn auf eines der Icons aus dem Overlay geklickt wird, erhält man die
      Feature Liste an diesem Punkt (die das Overlay entält), beim Klick auf das
      Overlay erscheint ein Info Dialog.</p>
    <img src="Overlay-Example-InfoDialog.png" alt="" class="fimage">
    <p>Man erhält die zum Punkt verfügbaren Informationen und die Möglichkeit
      z.B. diesen Punkt sofort als Zielpunkt zum Routing zu verwenden (Goto).<br>
      Über "Hide" kann das gesamte Overlay temporär ausgeblendet werden.<br>
      Wenn man sich momentan im <a href="../userdoc/editroutepage.html#featureInfo">Routen-Editor</a>
      befindet, stehen noch weitere Funktionen zur Verfügung.</p>
    Auf der <a href="../userdoc/navpage.html">Navigationsseite</a> und im <a href="../userdoc/editroutepage.html">Route-Editor</a>
    gibt es die Möglichkeit, Overlays aus- und einzublenden.<br>
    <p> Dazu auf der rechten Seite den <img src="../viewerimages/icons-new/layers-black.svg"
        alt="" class="inlineimage">Button verwenden.</p>
    <p><img src="Overlay-Config-ActiveOverlays.png" alt="" class="fimage"></p>
    <p>Hier kann man kurzfristig Overlays ein- und ausschalten. Diese
      Einstellungen bleiben wirksam, bis die gewählte Karte gewechselt wird. Sie
      betreffen auch nur das aktuelle Gerät, auf dem man arbeitet. Alle anderen
      Veränderungen an den Overlays finden immer auf dem Server statt und werden
      somit für alle Nutzer wirksam.</p>
    <p>Über Edit kann man wieder zur normalen Bearbeitung der Overlays wechseln.</p>
    <p><b>Hinweis:</b></p>
    <p>Wenn man Overlay-Dateien mit sehr vielen Elementen nutzt, kann das die
      Arbeitsgeschwindigkeit stark reduzieren. Momentan ist dort kein festes
      Limit eingebaut, Dateien von einigen 100MB werden allerdings mit
      Sicherheit Probleme bereiten. 1000 Punkte in einem Overlay sind dagegen
      kein Problem.</p>
    <h2>Änderungen von Overlays</h2>
    <p>Ab Version 20220225 überwacht AvNav die Overlay Dateien und sorgt dafür,
      das die Kartenansicht neu aufgebaut wird, wenn sich ein Overlay ändert.</p>
    <h2><a name="adaptation"></a>Anpassungen</h2>
    <p>Ab Version 20210114 kann man die Informationen anpassen, die aus der
      Overlay-Datei gewonnen werden und die dann bei "Feature Info" angezeigt
      werden. Das kann sinnvoll sein, da manchmal verfügbare Overlay Dateien
      Informationen enthalten, die AvNav von sich aus noch nicht kennt.</p>
    <p>Zu diesem Zweck kann man beim <a href="#configuration">Konfigurieren</a>
      des Overlays einen "featureFormatter" angeben. Dabei handelt es sich um
      eine Java Script Funktion, die entweder in AvNav schon vorhanden ist, die
      in der <a href="userjs.html">user.js</a> eingebaut wird, oder die von
      einem <a href="plugins.html">plugin</a> kommt.</p>
    <p>Diese Java Script Funktion bekommt als Parameter die in der Overlay Datei
      vorhandenen Eigenschaften des angeklickten Punktes und kann
      veränderte/neue Eigenschaften zurückgeben, die dann vom FeatureInfo Dialog
      angezeigt werden.</p>
    <p>Die folgenden Eigenschaften können zurückgegeben werden:</p>
    <table width="100%" border="1">
      <tbody>
        <tr>
          <td>Name</td>
          <td>Bedeutung</td>
        </tr>
        <tr>
          <td>sym</td>
          <td>die URL für ein anzuzeigendes Icon. Das kann eine relative URL
            sein, diese ist dann eine Icon Datei innerhalb der <a href="#configuration">konfigurierten</a>
            userIcons Datei, ein absoluter Pfad wie z.B.
            /user/images/myImage.png oder eine mit http: beginnende externe URL
            (natürlich dann nur mit Internet Verbindung nutzbar).</td>
        </tr>
        <tr>
          <td>name</td>
          <td>der anzuzeigende Name</td>
        </tr>
        <tr>
          <td>desc</td>
          <td>der unter "description" anzuzeigende Text</td>
        </tr>
        <tr>
          <td>htmlInfo</td>
          <td>ein html String, der dann bei Klick auf den <img src="../viewerimages/icons-new/ic_info.svg"
              alt="" class="inlineimage">Info Button angezeigt wird.</td>
        </tr>
        <tr>
          <td>time</td>
          <td>eine Zeitangabe (String oder java script Date)</td>
        </tr>
        <tr>
          <td>link</td>
          <td>eine URL, die bei Klick auf den <img src="../viewerimages/icons-new/ic_info.svg"
              alt="" class="inlineimage">Info Button angezeigt werden soll
            (alternativ zu htmlInfo). Es gelten die gleichen Regeln wie für
            "sym".</td>
        </tr>
      </tbody>
    </table>
    <p>Die übergebenen Parameter hängen von der Overlay Datei ab. Zusätzlich
      sind in jedem Falle die Werte "lat" und "lon" vorhanden.</p>
    <p>Ein Beispiel für die <a href="https://github.com/wellenvogel/avnav/blob/master/viewer/util/featureFormatter.js">eingebaute
        genericHtmlInfo</a> Funktion, die alle vorhandenen Werte als HTML in den
      Wert htmlInfo schreibt.</p>
    <div class="code">let genericHtmlInfo=function(properties,extended){
    if (! extended) return {};
    let htmlInfo='&lt;div class="featureInfoHtml"&gt;';
    for (let k in properties){
        if (!properties[k]) continue;
        if (htmlInfo !== "") htmlInfo+="&lt;br/&gt;";
        htmlInfo+=avnav.api.escapeHtml(k)+"="+avnav.api.escapeHtml(properties[k]);
    }
    htmlInfo+='&lt;/div&gt;';
    return {htmlInfo:htmlInfo};
}</div>
    <p>Der zweite Parameter, der an die Funktion übergeben wird, gibt einen
      Hinweis, ob alle Parameter erzeugt werden sollen oder nur der "sym"
      Parameter. Falls extended auf "false" gesetzt ist, sollte die Funktion
      keine zeitraubenden Operationen ausführen, da sie potentiell für jedes
      Element aus dem Overlay aufgerufen wird.</p>
    <p>Um selbst eine solche Funktion bei AvNav bekannt zu machen, muss sie wie
      folgt registriert werden (siehe <a href="userjs.html">user.js</a>).</p>
    <div class="code">avnav.api.registerFeatureFormatter('myHtmlInfo',myHtmlInfoFunction);</div>
    <p>Nachdem die Funktion registriert wurde, kann sie in der Overlay <a href="#configuration">Konfiguration</a>
      ausgewählt werden.</p>
    <p><br>
    </p>
    <p><br>
    </p>
  </body>
</html>
