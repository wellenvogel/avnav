<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>AvNav OCharts</title>
    <link href="../styles.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <h1>Avnav Ocharts</h1>
    <p>=== nicht für Android ===</p>
    <h3>Inhalt</h3>
    <ul>
      <li><a href="#Charts">Erwerb und Installation der Karten</a></li>
      <li><a href="#MainSettings">Anpassung des Aussehens</a></li>
      <li><a href="#Installation">Installation</a></li>
      <li><a href="#License">Lizenzhinweise</a></li>
      <li><a href="#Details">Technische Details</a></li>
    </ul>
    <p>AvNav kann Karten in den verschiedenen Raster-Formaten verarbeiten.
      Bisher war es aber nicht in der Lage, offiziell verfügbare Seekarten zu
      lesen und anzuzeigen. Seit einiger Zeit gibt es die Firma <a href="https://o-charts.org/">o-charts</a>,
      die Karten für viele Gebiete der Erde für OpenCPN bereitstellt.</p>
    <p>Nach einigen Absprachen mit der Firma können diese Karten nun (ab Version
      20200515 mit einem Plugin - <a href="#Installation">s.u.</a>) auch für
      AvNav genutzt werden. Bisher können die oesenc Vektor-Karten genutzt
      werden.</p>
    <p>Um die Karten in AvNav darzustellen, müssen sie zunächst einmal in Raster
      Karten umgewandelt werden. Das erledigt ein neues Plugin für AvNav
      (avnav-ocharts). Die Umwandlung erfolgt dabei im laufenden Betrieb immer
      dann, wenn die Karten dargestellt werden sollen. Damit kann mit diesen
      Karten weitgehend normal gearbeitet werden ohne das man sich um diesen
      Prozess kümmern muss.</p>
    <p>Das Handling der Karten erfolgt dabei vollständig durch das Plugin - das
      betrifft auch die Installation (die Karten können nicht über die normale <a
        href="../userdoc/downloadpage.html">Download-Seite</a> hochgeladen
      werden). Das Plugin hat dazu eine eigene GUI, die von der Hauptseite über
      den Button <img src="../viewerimages/icons-new/apps.svg" alt="" class="inlineimage">(User
      Apps) und dort über den Button Ocharts-Provider&nbsp; <img src="ochartsicon.png"
        alt="" class="inlineimage"> erreichbar ist.</p>
    <img src="ocharts-gui-1.png" alt="" class="image"><br>
    <h2><a name="Charts"></a>Erwerb und Installation der Karten</h2>
    <p>Um bei ocharts Karten kaufen zu können, muss <a href="https://o-charts.org/shop/de/autenticacion?back=my-account">dort</a>
      zunächst ein Konto angelegt werden.</p>
    <p>Anschliessend muss man seine Systeme, auf denen man die Karten nutzen
      möchte <a href="https://o-charts.org/shop/de/module/occharts/occharts">auf
        der Seite von o-charts</a> registrieren. AvNav benutzt dabei den <a href="https://manuals.o-charts.org/oesenc_de_DE.html">"Offline"
        Prozess</a> . </p>
    <p>Dieser besteht aus den folgenden Schritten:</p>
    <ol>
      <li>Erzeugung eines "Fingerprints" für das System, auf dem die Karten
        genutzt werden sollen. Dieser kann in AvNav über die Bedienoberfläche
        des Plugins erzeugt und heruntergeladen werden.</li>
      <li>Hochladen dieses Fingerprints zu o-charts und Anlegen eines Systems
        (im Wesentlichen Vergabe eines Namens)</li>
      <li>Kaufen von Karten</li>
      <li>Zuordnen zu dem angelegten System</li>
      <li>Nach kurzer Zeit gibt es eine Mail von o-charts mit einem
        Download-Link für die Karten (Zip-File)</li>
      <li>Hochladen der Karten in AvNav (wieder über die Bedienoberfläche des
        Plugins).</li>
    </ol>
    <p>Für Updates werden die Schritte 4,5 und 6 wiederholt (bei 4 nur
      Anforderung des Updates).</p>
    <p>Für weitere Kartensätze Schritte 3-6.</p>
    <p>Für die Schritte 2,3,4 und 5 wird natürlich ein System mit
      Internet-Verbindung benötigt. Das kann z.B. ein Laptop oder auch ein
      Android Tablet sein.</p>
    <p>Für den Ablauf des Prozesses habe ich ein <a href="https://www.youtube.com/watch?v=q24VRAtbbEE">Video</a>
      gemacht, um ihn zu verdeutlichen. Hier noch einmal eine kurze Beschreibung
      dazu.</p>
    <h3>1. Erzeugung des Fingerprints</h3>
    <p>Über <img src="../viewerimages/icons-new/apps.svg" alt="" class="inlineimage">-&gt;<img
        src="ochartsicon.png" alt="" class="inlineimage">auf die Oberfläche des
      Plugins gehen, dort den Tab "Charts" auswählen.</p>
    <img src="ocharts-gui-charts1.png" alt="" class="image">
    <p>Mit "Get Fingerprint" die Erzeugung des Fingerprints anstossen. Falls man
      einen Dongle von o-charts benutzt, den Fingerprint über "Get
      Fingerprint(Dongle)" erzeugen.</p>
    <p><img src="ocharts-gui-charts2.png" alt="" class="image"></p>
    <p>Im Dialog die erzeugte Datei auf meinem Gerät speichern.</p>
    <h3>2. Hochladen des Fingerprints zu o-charts</h3>
    <p>Auf die <a href="https://o-charts.org/shop/de/module/occharts/occharts">o-charts
        Seit</a>e gehen und den Fingerprint hochladen.</p>
    <img src="ocharts-buying.png" alt="" class="image">
    <p>Mit Choose File die unter 2. gespeicherte Datei wählen. Dazu einen
      sinnvollen Namen vergeben (dieser findet sich später in den Mails mit den
      Download Links).</p>
    <h3>3. Kaufen von Karten</h3>
    <p>Bei o-charts aus den verfügbaren <a href="https://o-charts.org/shop/de/8-oesenc">oeSENC
        Karten</a> die gewünschten kaufen.</p>
    <h3>4. Zuordnen zum angelegten System</h3>
    <img src="ocharts-assign.png" alt="" class="image">
    <p>Bei 1 kann die Zuordnung zu einem angelegten System erfolgen (hier nicht
      mehr möglich, weil die Karten bereits zu den 2 maximal verfügbaren
      Systemen zugeordnet sind). Bei 2 wird dann die Mail mit dem Download-Link
      angefordert (das erfolgt auch bei Updates - hier im Bild zu sehen: Die
      letzte abgerufene Version ist 21, verfügbar ist 23).</p>
    <h3>5. Herunterladen der Karten</h3>
    <img src="ocharts-download.png" alt="" class="image">
    <p>Nach kurzer Zeit erhält man von o-charts eine mail mit dem Download-Link.
      Diese Datei (zip) herunterladen.</p>
    <p>6. Hochladen der Zip-Datei zu AvNav.</p>
    <p><img src="ocharts-upload1.png" alt="" class="image"></p>
    <p>In der GUI des o-chart plugins über "Upload Zip" die im Schritt 5.
      heruntergeladene Datei zu AvNav hochladen.</p>
    <p>Während des Uploads wird ein Fortschritt angezeigt.</p>
    <p><img src="ocharts-upload2.png" alt="" class="image"></p>
    <p>Am Ende des Uploads wird auf dem AvNav Server die Datei ausgepackt und es
      werden einige Prüfungen durchgeführt (das kann einige Sekunden dauern).</p>
    <p>Die Karten werden (falls nicht anders konfiguriert) in das Verzeichnis
      /home/pi/avnav/data/ocharts/charts hochgeladen.</p>
    <p><img src="ocharts-upload3.png" alt="" class="image"></p>
    <p>Wenn alle Prüfungen erfolgreich waren, wird angeboten sofort das Plugin
      zu restarten um die Karten nutzen zu können.</p>
    <p>Falls es sich bei den neu hochgeladenen karten um ein Update schon
      vorhandener Karten handelt, wírd der vorhandene Satz deaktiviert und der
      neue Satz aktiviert (beim restart). Das kann in der GUI später geändert
      werden. Nicht mehr benötigte Sätze können hier gelöscht werden.</p>
    <p>Beim Restart kommt es kurzzeitig zu einigen Fehlermeldungen, aber nach
      max. 30s sollte der Status zumindest wieder gelb sein (das Plugin liest
      jetzt alle vorhandenen Karten).</p>
    <p>Wenn die Karten erfolgreich geladen werden konnten, sollte am Ende der
      Status für die Karten auf grün (READY) gehen.</p>
    <p><img src="ocharts-upload4.png" alt="" class="image"></p>
    <p>Falls der Status zu "ERROR" (rot) wird, wurde u.U. ein Zip-File
      hochgeladen, was für ein anderes System zugeordnet war. Details kann man
      im Log File (/home/pi/avnav/data/ocharts/provider.log) sehen.</p>
    <p>Nun sind die Karten verfügbar und können genutzt werden.<br>
      Unter dem Tab Status kann man etwas mehr Details erhalten.</p>
    <img src="ocharts-status-filling.png" alt="" class="image">
    <p>Im Bild ist zu sehen, das nach dem Hochladen jetzt automatisch bereits
      eine Erzeugung von Kartenkacheln angelaufen ist ("Cache Prefill"). Das
      sorgt dafür, das die Verzögerungen, die sonst bei der Nutzung durch die
      begrenzten Resourcen des raspberry pi entstehen können, verringert werden.
      Dazu wird nach einem bestimmten Verfahren ein Teil der Kacheln im Bereich
      des Kartensatzes vorab erzeugt und in einem Cache File gespeichert.</p>
    <p>Trotzdem können die Karten auch bereits unmittelbar genutzt werden.</p>
    <p><img src="ocharts-mainpage.png" alt="" class="image"></p>
    <p><img src="ocharts-navpage.png" alt="" class="image"></p>
    <p>Wie bereits erwähnt kann es bei der erstmaligen Nutzung in einem
      bestimmten Bereich zu Verzögerungen kommen (insbesondere auf den
      kleineren/älteren Pi's) - nach der einmaligen Nutzung sind die Kacheln für
      den Bereich aber im Cache und die Verzögerungen sind minimal.</p>
    <h2><a name="MainSettings"></a>Anpassung des Aussehens</h2>
    <p>Da die O-charts Karten zunächst als Vektorkarten vorhanden sind, kann in
      weiten Bereichen das Aussehen der Karten angepasst werden. Dabei sind
      allerdings einige Einschränkungen zu beachten:</p>
    <ol>
      <li>Die Anpassung erfolgt auf der Server-Seite und ist damit für alle
        verbundenen Displays gleichartig wirksam</li>
      <li>Wenn das Aussehen geändert wird, müssen alle bereits im Cache
        vorhandenen Daten gelöscht werden und alle Karten-Kacheln müssen neu
        berechnet werden. Das kann auf langsamen Systemen wieder zu
        Verzögerungen führen. Es läuft sofort wieder der automatische
        Prefill-Prozess an, um möglichst viele Kacheln schon vorberechnet zur
        Verfügung zu haben.</li>
    </ol>
    <p>Die Veränderung der Parameter erfolgt über die GUI des Plugins (<img src="../viewerimages/icons-new/apps.svg"
        alt="" class="inlineimage">-&gt;<img src="ochartsicon.png" alt="" class="inlineimage">),
      Tab "Main Settings".</p>
    <img src="ocharts-settings1.png" alt="" class="image">
    <p>Wenn eine Einstellung geändert wird (1) wird der Parameter fett
      dargestellt. Die Änderungen werden erst wirksam, wenn "Update Settings"(2)
      angeklickt wird.</p>
    <p>Mit Cancel können die Änderungen zurückgenommen werden, Defaults setzt
      die Einstellungen auf Default-Werte. Die Parameter entsprechen weitgehend
      den bei <a href="https://opencpn.org/wiki/dokuwiki/doku.php?id=opencpn:opencpn_user_manual:options_setting">OpenCPN
        vorhandenen Settings</a>.</p>
    <p>Die folgende Tabelle listet die Einstellungen.</p>
    <table border="1" width="100%">
      <tbody>
        <tr>
          <td>Name</td>
          <td>Bedeutung</td>
          <td>Default</td>
        </tr>
        <tr>
          <td>Show Text</td>
          <td>Zeige Texte zu den Objekten auf der Karte</td>
          <td>true</td>
        </tr>
        <tr>
          <td>Important Text Only</td>
          <td>Verberge weniger wichtige Texte</td>
          <td>false</td>
        </tr>
        <tr>
          <td>Light Descriptions</td>
          <td>Beschreibungen für Feuer</td>
          <td>true</td>
        </tr>
        <tr>
          <td>Extended Light Sectors</td>
          <td>Sektoren für Feuer</td>
          <td>true</td>
        </tr>
        <tr>
          <td>Show Depth</td>
          <td>Zeige Tiefen Werte</td>
          <td>true</td>
        </tr>
        <tr>
          <td>Chart Information Objects</td>
          <td>spezielle Objekte auf der Karte</td>
          <td>true</td>
        </tr>
        <tr>
          <td>Buoy/Light Labels</td>
          <td>Bezeichnungen für Feuer/Tonnen</td>
          <td>true</td>
        </tr>
        <tr>
          <td>National text on chart</td>
          <td>Nationale Texte</td>
          <td>true</td>
        </tr>
        <tr>
          <td>Show Lights</td>
          <td>Zeige Feuer</td>
          <td>true</td>
        </tr>
        <tr>
          <td>Reduced Detail at Small Scale</td>
          <td>Reduziere die Details auf geringeren Zoom-Leveln</td>
          <td>true</td>
        </tr>
        <tr>
          <td>De-Cluttered Text</td>
          <td>Bessere Anordnung der Texte</td>
          <td>true</td>
        </tr>
        <tr>
          <td>Display Category</td>
          <td>Art der Darstellung (Base,Standard,All,User Standard)</td>
          <td>All</td>
        </tr>
        <tr>
          <td>Graphics Style</td>
          <td>Grafische Darstellung (Paper Chart, Simplified)</td>
          <td>Paper Chart</td>
        </tr>
        <tr>
          <td>Boundaries</td>
          <td>Art der Begrenzungen (Plain, Symbolized)</td>
          <td>Plain</td>
        </tr>
        <tr>
          <td>Colors</td>
          <td>Farben (4Color, 2 Color)</td>
          <td>4 Color</td>
        </tr>
        <tr>
          <td>Text Font Size</td>
          <td>Skalierung für die Text-Grösse</td>
          <td>1 (ca. 12px)</td>
        </tr>
        <tr>
          <td>Soundings Font Size</td>
          <td>Skalierung für die Tiefen-Angaben (ab oesenc-pi 4.2.x)</td>
          <td>1 (ca. 12px)</td>
        </tr>
        <tr>
          <td>Scale</td>
          <td>Basis Skalierung. Höhere Werte sorgen für mehr Details auf
            kleineren Zoom-Stufen</td>
          <td>2</td>
        </tr>
        <tr>
          <td>UnderZoom</td>
          <td>Anzahl der Zoom Stufen, die eine höher aufgelöste Karte
            verkleinert wird, wenn auf dem gewünschten Level keine Karte
            vorhanden ist</td>
          <td>1</td>
        </tr>
        <tr>
          <td>OverZoom</td>
          <td>Anzahl der Zoom Stufen, die eine niedriger aufgelöste Karte
            vergrößert wird,wenn es keine besser aufgelöste Karte gibt.<br>
            <b>Hinweis</b>: Scale,UnderZoom und OverZoom bestimmen massgeblich,
            wie aufwendig der Render-Vorgang ist, d.h. wieviele Karten an der
            Erzeugung einer Kachel beteiligt werden müssen. Kleinere Werte
            führen zu weniger Karten (schneller) können aber in bestimmten
            Bereichen zu weissen Flächen zwischen Karten-Teilen führen. Die
            defaults sollten ein guter Kompromiß sein.</td>
          <td>4</td>
        </tr>
        <tr>
          <td>Depth</td>
          <td>Einheit für die Tiefen-Angaben (Meters, Feet, Fathoms)</td>
          <td>Meters</td>
        </tr>
        <tr>
          <td>Shallow Depth</td>
          <td>Tiefe für Flachwasser</td>
          <td>2</td>
        </tr>
        <tr>
          <td>Safety Depth</td>
          <td>Tiefe für Sicherheits-Kontur</td>
          <td>3</td>
        </tr>
        <tr>
          <td>Deep Depth</td>
          <td>Tiefe für Tiefwasser</td>
          <td>6</td>
        </tr>
      </tbody>
    </table>
    <p>Unter dem Tab "Detail Settings" können gezielt einzelne Karten-Features
      an- oder abgeschaltet werden.</p>
    <h2><a name="Installation"></a>Installation</h2>
    <p>Die Installation kann normal als Pakete in den AvNav Images erfolgen. Für
      die <a href="../install.html#Headless">Headless Images</a> sind die
      Pakete bereits im Repository vorhanden. Es müssen die Pakete</p>
    <ul>
      <li>avnav-ocharts-plugin</li>
      <li>avnav-oesenc</li>
    </ul>
    <p>installiert werden. Für das Paket avnav-ocharts-provider ist mindestens
      die Version 20200606 nötig. Das Paket avnav-oesenc ist das oesenc-pi
      plugin - allerdings so verpackt, das es nach
      /usr/lib/avnav/plugins/ocharts installiert wird, um Konflikte mit einer
      OpenCPN Installation zu vermeiden.</p>
    <div class="code">sudo apt-get update<br>sudo apt-get install avnav-ocharts-plugin avnav-oesenc<br>sudo systemctl restart avnav</div>
    <p>Falls auf anderen Images gearbeitet wird, sollte das Repository von
      free-x hinzugefügt werden.</p>
    <div class="code">deb https://www.free-x.de/debian buster main contrib non-free</div>
    <p>Eine Bereitstellung der Pakete auf dieser Seite hier wird in der nächsten
      Zeit noch erfolgen.</p>
    <h2><a name="License"></a>Lizenzhinweise</h2>
    <p>Die Nutzung der Karten für AvNav mit dem oesenc-pi Plugin ist so mit
      o-charts diskutiert und abgestimmt worden und ist damit legal im Sinne der
      Lizenzen.<br>
      Die <a href="https://manuals.o-charts.org/docs/EN_rrc_eula_ChartSetsForOpenCPN.html">Lizenzbedingungen
        von o-charts</a> sind dabei unbedingt zu beachten. Es ist insbesondere
      nicht gestattet, die Karten zu kopieren oder auf anderen als den
      lizensierten Systemen einzusetzen.</p>
    <p>Der Zugriff auf die Karten innerhalb von AvNav ist nur aus dem lokalen
      Netz möglich, maximal können 5 Geräte (Clients) gleichzeitig die o-charts
      von einem AvNav Server nutzen.</p>
    <p>Für die Software-Lizenzen siehe die <a href="https://github.com/wellenvogel/avnav-ocharts-provider/blob/master/Readme.md">Readme.</a></p>
    <h2><a name="Details"></a>Technische Details</h2>
    <p>Die eigentliche Bereitstellung der Karten erfolgt durch ein executable
      auf dem Raspberry, das standardmäßig über den Port 8082 erreichbar ist.
      Dieses executable lädt das oesenc-pi OpenCPN plugin. <br>
      Die Kommunikation mit AvNav erfolgt über ein <a href="plugins.html">plugin</a>
      in AvNav.</p>
    <p>Die GUI ist eine reactjs Anwendung, die ebenfalls durch das executable
      bereitgestellt wird und in AvNav als <a href="../userdoc/addonpage.html">User
        App</a> integriert ist.</p>
    <p>Der Code ist verfügbar auf <a href="https://github.com/wellenvogel/avnav-ocharts-provider">GitHub</a>.</p>
    <p>Die Installation erfolgt in das Verzeichnis
      /usr/lib/avnav/plugins/ocharts. Die Daten liegen im Verzeichnis
      /home/pi/avnav/data/ocharts. Für das Plugin können in der <a href="configfile.html">avnav_server.xml
        </a>einige Konfigurationen vorgenommen werden. Im Normalfall ist das
      aber nicht nötig. Falls solche Konfigurationen erfolgen sollen, müssen sie
      unterhalb des Plugin-Managers stattfinden.</p>
    <div class="code">&lt;AVNPluginHandler&gt;<br>...<br>&lt;system-ocharts port="8082".../&gt;<br>&lt;/AVNPluginHandler&gt;</div>
    <p>Für eine Liste der Konfigurationswerte siehe die <a href="https://github.com/wellenvogel/avnav-ocharts-provider/blob/master/avnav-plugin/plugin.py">Beschreibung
        im code des Plugins</a>.</p>
    <p><br>
    </p>
    <p><br>
    </p>
  </body>
</html>
